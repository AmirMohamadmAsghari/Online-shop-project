{% extends 'base.html' %}
{% load custom_filters %}
{% block title %}Your Cart{% endblock %}
{% block style %}
<style>
    .cart-item {
        border-bottom: 1px solid #ddd;
        padding: 15px;
        display: flex;
        align-items: center;
    }

    .cart-item img {
        max-width: 100px;
        height: auto;
        margin-right: 20px;
    }

    .cart-item-details {
        flex: 1;
    }

    .cart-item-details h3 {
        margin: 0;
    }

    .cart-item-price {
        font-weight: bold;
    }

    .total-section {
        margin-top: 20px;
        padding: 20px;
        background-color: #f5f5f5;
    }

    .total-section h2 {
        margin-top: 0;
    }

    .checkout-button {
        display: block;
        width: 100%;
        padding: 10px;
        background-color: #007bff;
        color: #fff;
        text-align: center;
        text-decoration: none;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .checkout-button:hover {
        background-color: #0056b3;
    }

    .cart-items-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }

    .column {
        flex: 1;
        max-width: calc(50% - 20px);
    }

    .btn {
        display: inline-block;
        padding: 8px 16px;
        background-color: #007bff;
        color: #fff;
        text-decoration: none;
        border-radius: 5px;
        transition: background-color 0.3s;
        border: none;
        cursor: pointer;
    }

    .btn:hover {
        background-color: #0056b3;
    }

    .btn-add {
        margin-top: 20px;
    }
</style>
{% endblock %}
{% block content %}
<div class="container mt-5 cart-content">
    <h1>Your Orders</h1>
    {% if products %}
        <div class="cart-items-container">
            {% for product in products %}
                <div class="cart-item column">
                    {% with image=images|dict_key:product.product.id %}
                        {% if image %}
                            <img src="{{ image.image.url }}" alt="{{ product.product.title }}">
                        {% endif %}
                    {% endwith %}
                    <div class="cart-item-details">
                        <h3>{{ product.product.title }}</h3>
                        <p>{{ product.product.description }}</p>
                        <p class="cart-item-price">Price: ${{ product.price }}</p>
                        <p>Discounted Price: ${{ product.discounted_price }}</p>  <!-- Display discounted price -->
                        <p>Quantity: {{ product.quantity }}</p>
                        <button class="btn btn-secondary btn-increase" data-id="{{ product.product.id }}">+</button>
                        <button class="btn btn-secondary btn-decrease" data-id="{{ product.product.id }}">-</button>
                    </div>
                </div>
            {% endfor %}

        </div>
    {% else %}
        <p>No products in your cart.</p>
    {% endif %}

    <div class="total-section">
        <h2>Total</h2>
        <p>Total items: {{ total_items }}</p>
        <p>Total price: ${{ total_price }}</p>
        <a href="{% url 'address-list' %}" class="btn btn-add">Select Address</a>
        <a href="{% url 'checkout' %}" class="checkout-button">Proceed to Checkout</a>
    </div>
</div>
{% endblock %}
{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function attachEventListeners() {
        const increaseButtons = document.querySelectorAll('.btn-increase');
        const decreaseButtons = document.querySelectorAll('.btn-decrease');

        increaseButtons.forEach(button => {
            button.addEventListener('click', function() {
                const productId = this.getAttribute('data-id');
                updateQuantity(productId, 'increase');
            });
        });

        decreaseButtons.forEach(button => {
            button.addEventListener('click', function() {
                const productId = this.getAttribute('data-id');
                updateQuantity(productId, 'decrease');
            });
        });
    }

    function updateQuantity(productId, action) {
        fetch('/order/view-order/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                product_id: productId,
                action: action
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.html) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(data.html, 'text/html');
                const newCartContent = doc.querySelector('.cart-content');
                document.querySelector('.cart-content').innerHTML = newCartContent.innerHTML;
                // Reattach event listeners after updating cart content
                attachEventListeners();
            }
            if (data.error) {
                console.error(data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // Initial attachment of event listeners
    attachEventListeners();
});
</script>
{% endblock %}
